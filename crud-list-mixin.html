
<script>
  /**
   * CRUD Mixin for the entity list.
   *
   * @polymerMixin
   */
  window.CrudListMixin = subclass => class extends subclass {
    static get properties() {
      return {
        /**
         * The item activated in the list
         */
        activeItem: {
          type: Object,
          observer: '_onActiveItem'
        },
        /**
         * The item to edit.
         */
        item: Object,
        /**
         * The string used to filter items
         */
        search: String
      };
    }

    /**
     * `true` if the editor has a `dirty` flag
     */
    get dirty() {
      return this.$.editor && this.$.editor.dirty;
    }

    _onActiveItem() {
      this._editItem();
    }

    /**
     * Create a new item, and edit it.
     */
    new() {
      this.activeItem = {};
    }

    _editItem() {
      // activeItem is set after clicking on grid elements
      setTimeout(() => {
        this.item = this.activeItem;
        this.editing = !!this.item;
      });
    }

    /**
     * Close the editor and unselect the edited item.
     */
    close() {
      if (this.$.grid) {
        this.$.grid.selectedItems = [];
        this.$.grid.activeItem = null;
      }
      this.item = {};
      this.item = null;
      this.editing = false;
    }

    /**
     * Save the edited item.
     */
    save(e) {
      var idx = this.items.indexOf(this.item);
      if (this.items && idx >= 0) {
        this.set('items.' + idx, e.detail);
      } else {
        this.items && this.push('items', e.detail) || this.set('items', [e.detail]);
      }
    }

    /**
     * Remove the edited item.
     */
    delete(e) {
      this.splice('items', this.items.indexOf(this.item), 1);
    }

    /**
     * Return the list of filtered items
     */
    filter(items, search) {
      if (items) {
        return !search ? items.slice(0) : items.filter((item) => {
          return Object.keys(item).reduce((last, current) => {
            return last || String(item[current]).toLowerCase().includes(search.toLowerCase());
          }, false);
        });
      }
    }
  };

</script>
